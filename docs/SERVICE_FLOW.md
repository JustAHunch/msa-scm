# B2B 물류 관리 및 배송 시스템 - 서비스 플로우

## 개요
본 문서는 B2B 물류 관리 및 배송 시스템의 전체 서비스 플로우를 설명합니다.
각 단계별 프로세스와 이벤트 흐름을 통해 시스템의 비즈니스 로직을 이해할 수 있습니다.

## 플로우 다이어그램
플로우 다이어그램은 `SERVICE_FLOW.mermaid` 파일을 참조하세요.

## 주요 프로세스

### 1. 인증 및 계정 관리
- **회원가입**: 업체 정보를 등록하고 시스템 접근 권한을 부여받습니다
- **로그인**: 인증된 사용자만 시스템 기능을 사용할 수 있습니다
- **인증 실패 처리**: 인증 실패 시 알림을 전송하고 재시도를 유도합니다

### 2. 상품 및 재고 관리
#### 2.1 상품 등록
- 업체가 배송할 상품 정보를 시스템에 등록합니다
- 상품명, 규격, 수량, 보관 조건 등의 정보를 입력합니다

#### 2.2 허브 입고
- **입고 신청**: 상품을 특정 허브에 입고 신청합니다
- **입고 검수**: 허브 관리자가 상품의 품질과 수량을 확인합니다
- **품질 확인**:
  - 합격: 재고로 등록하고 **재고 증가 이벤트** 발행
  - 불합격: 입고를 거부하고 반송 처리

#### 2.3 재고 관리
- 허브별 재고 현황을 실시간으로 관리합니다
- 안전 재고 수준을 모니터링하고 알림을 제공합니다

### 3. 배송 주문 및 재고 예약
#### 3.1 배송 주문 생성
- 업체가 목적지 정보와 함께 배송 주문을 생성합니다
- 출발지 허브와 목적지 허브 정보를 확인합니다

#### 3.2 재고 확인 및 예약
- 주문 수량에 대한 재고 가용성을 확인합니다
- **재고 있음**: 재고를 예약하고 **재고 차감 이벤트** 발행
- **재고 부족**: 알림을 전송하고 주문을 보류합니다

#### 3.3 배송 경로 계산
- 출발지 허브에서 목적지까지 최적 경로를 계산합니다
- 허브 간 이동이 필요한지 판단합니다

### 4. 허브 간 이동 및 재고 이전
#### 4.1 출고 처리
- **출발 허브 재고 차감**: 출고 시 출발 허브의 재고를 차감합니다
- **출고 확인**: 출고 수량과 상품 상태를 확인합니다

#### 4.2 허브 간 이동 (필요시)
- **차량 배차**: 대형 화물 차량을 배정하고 이동 계획을 수립합니다
- **운송 추적**: 허브 간 이동 중 실시간 위치를 추적합니다
- **목적지 허브 도착**: 상품이 목적지 허브에 도착하면 검수하고 입고 처리합니다

#### 4.3 목적지 허브 재고 등록
- 목적지 허브에 상품이 도착하면 **재고 증가 이벤트**를 발행합니다
- 허브 간 재고 이전이 완료되었음을 시스템에 반영합니다

### 5. 최종 배송
#### 5.1 배송 시작
- **배송기사 배정**: 목적지 지역의 배송기사를 자동으로 배정합니다
- **배송 시작 알림**: 고객에게 배송 시작 알림을 전송합니다

#### 5.2 배송 추적
- GPS를 통해 실시간 배송 위치를 공유합니다
- 예상 도착 시간을 업데이트합니다

#### 5.3 배송 완료 처리
- **성공**: 
  - 배송 완료 알림을 전송합니다
  - 최종 재고 상태를 확정합니다
- **실패**: 
  - **재고 원복 이벤트** 발행
  - 재배송 처리 또는 반품 프로세스를 시작합니다

### 6. 정산
#### 6.1 배송비 정산
- 배송 완료 후 거리, 중량, 허브 간 이동 여부 등을 기반으로 배송비를 계산합니다

#### 6.2 세금계산서 발행
- 정산 내역을 기반으로 세금계산서를 자동으로 발행합니다

#### 6.3 정산 완료
- 정산 완료 알림을 업체에 전송합니다

## 재고 이벤트 흐름
시스템은 Event-Driven Architecture를 사용하여 다음과 같은 재고 이벤트를 발행합니다:

### 재고 증가 이벤트 (`inventory.increased`)
- 허브 입고 완료 시
- 허브 간 이동 후 목적지 허브 도착 시

### 재고 차감 이벤트 (`inventory.decreased`)
- 배송 주문 생성 및 재고 예약 시
- 허브 출고 처리 시

### 재고 원복 이벤트 (`inventory.restored`)
- 배송 실패 시
- 주문 취소 시
- 반품 처리 시

## 전체 이벤트 목록
시스템에서 발행되는 모든 이벤트:

### order.events (주문 이벤트)
- `order.created`: 주문 생성
- `order.confirmed`: 주문 확정 (재고 예약 완료)
- `order.cancelled`: 주문 취소
- `order.updated`: 주문 정보 변경

### inventory.events (재고 이벤트)
- `inventory.increased`: 재고 증가 (입고, 허브 도착)
- `inventory.decreased`: 재고 차감 (예약, 출고)
- `inventory.restored`: 재고 원복 (배송 실패, 취소)
- `inventory.low`: 재고 부족 경고

### delivery.events (배송 이벤트)
- `delivery.started`: 배송 시작
- `delivery.in_transit`: 배송 중 (허브 간 이동)
- `delivery.arrived_hub`: 목적지 허브 도착
- `delivery.out_for_delivery`: 최종 배송 출발
- `delivery.completed`: 배송 완료
- `delivery.failed`: 배송 실패

### hub.events (허브 이벤트)
- `hub.inbound_requested`: 입고 신청
- `hub.inbound_completed`: 입고 완료
- `hub.inbound_rejected`: 입고 거부 (품질 불량)
- `hub.outbound_requested`: 출고 신청
- `hub.outbound_completed`: 출고 완료
- `hub.transfer_started`: 허브 간 이동 시작
- `hub.transfer_completed`: 허브 간 이동 완료

## SAGA 패턴을 통한 보상 트랜잭션
배송 실패나 재고 부족 등의 예외 상황에서 다음과 같은 보상 트랜잭션이 실행됩니다:

### 1. 배송 실패 시
```
배송 실패 감지
  → inventory.restored 이벤트 발행 (재고 원복)
  → order.cancelled 이벤트 발행 (주문 취소)
  → 고객 알림 전송
  → 배송비 정산 취소 또는 재정산
```

### 2. 재고 부족 발견 시
```
재고 부족 확인
  → order.cancelled 이벤트 발행 (주문 취소)
  → 고객 안내 알림
  → 대체 허브 제안 (가능 시)
```

### 3. 허브 간 이동 실패 시
```
이동 실패 감지
  → 출발 허브 재고 원복
  → 대체 경로 탐색
  → 재배송 계획 수립
```

### 4. 입고 거부 시 (품질 불량)
```
품질 검사 불합격
  → hub.inbound_rejected 이벤트 발행
  → 반송 처리 시작
  → 반송 물류비 정산 (공급자 부담)
  → 업체 알림 전송 (비용 청구 포함)
  → 입고 거부 이력 기록
```

## 반송 물류비 정산 규칙

반송 처리 시 물류비용은 **귀책사유(누구의 잘못인가)**에 따라 부담 주체가 결정됩니다:

### 공급자(판매자) 귀책사유
다음의 경우 공급자가 왕복 운송비 전액을 부담합니다:
- 품질 불량, 상품 파손
- 오배송, 수량 부족/과다
- 계약 내용과 다른 상품 배송
- 허브 입고 검수 불합격

**정산 처리**:
```
반송 물류비 = 초기 입고 운송비 + 반송 운송비
부담자: 공급자
정산 방식: 공급자 정산금에서 차감 또는 별도 청구
```

### 구매자 귀책사유
다음의 경우 구매자가 왕복 운송비를 부담합니다:
- 단순 변심, 주문 취소
- 주문 착오 (수량, 상품 오류)
- 수령 거부 (정당한 사유 없음)

**정산 처리**:
```
반송 물류비 = 초기 배송비 + 반품 운송비
부담자: 구매자
정산 방식: 환불금에서 차감 또는 별도 청구
```

### 배송 실패 시
배송 실패 원인에 따라 부담 주체가 결정됩니다:
- **수령자 부재/거부**: 구매자 부담
- **주소 오류**: 구매자 부담
- **배송 기사 과실**: 물류 회사 부담
- **악천후 등 불가항력**: 협의 또는 규정에 따름

**비용 구성**:
```
재배송 비용 = 실패한 배송 시도 비용 + 재배송 운송비
부담자: 귀책사유에 따라 결정
```

### 허브 간 이동 실패 시
이동 실패 원인에 따라 비용이 정산됩니다:
- **차량 고장**: 운송업체 부담
- **경로 오류**: 시스템 운영자 협의
- **적재 불량**: 출발 허브 부담

## 알림 채널
시스템은 다음 채널을 통해 알림을 전송합니다:
- **SMS**: 배송 시작, 배송 완료 등 중요 알림
- **이메일**: 세금계산서, 정산 내역 등 문서 전송
- **푸시 알림**: 실시간 배송 추적 업데이트
- **WebSocket**: 관리 콘솔의 실시간 상태 업데이트

## 오류 처리
각 프로세스에서 발생할 수 있는 오류와 처리 방법:

| 오류 유형 | 처리 방법 | 보상 트랜잭션 | 비용 부담 |
|---------|---------|------------|---------|
| 인증 실패 | 재시도 유도 및 계정 잠금 확인 | - | - |
| 재고 부족 | 알림 전송 및 대체 허브 제안 | 주문 보류 또는 취소 | - |
| 입고 거부 | 반송 처리 및 업체 알림 | 반송 이력 기록 | 공급자 부담 |
| 출고 실패 | 재시도 또는 대체 재고 할당 | 재고 예약 취소 | - |
| 허브 이동 실패 | 대체 경로 또는 차량 재배차 | 재고 상태 원복 | 원인자 부담 |
| 배송 실패 | 재배송 처리 및 고객 안내 | 재고 원복, 주문 상태 롤백 | 귀책사유자 부담 |
| 정산 오류 | 수동 정산 처리 요청 | 정산 이력 보정 | - |

## 관련 문서
- [아키텍처 다이어그램](./ARCHITECTURE.md)
- [프로젝트 진행 상황](./PROJECT_PROGRESS.md)
- [코딩 컨벤션](./CODING_CONVENTION.md)
